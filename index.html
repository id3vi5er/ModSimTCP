<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus PV Simulator Status</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            background-color: #ffffff;
            font-size: 0.9em;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #dddddd;
            white-space: nowrap;
        }
        thead th {
            background-color: #4a6fa5;
            color: #ffffff;
            font-weight: bold;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
        .status-running {
            color: #27ae60;
            font-weight: bold;
        }
        .status-fault, .status-error {
            color: #c0392b;
            font-weight: bold;
        }
        .status-initializing, .status-standby {
            color: #f39c12;
            font-weight: bold;
        }
        .controls-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .controls-container label {
            font-weight: bold;
        }
        #cycle-speed-slider {
            width: 300px;
        }
    </style>
</head>
<body>

    <h1>Modbus PV Simulator Status</h1>

    <div class="controls-container">
        <label for="cycle-speed-slider">Simulationsgeschwindigkeit:</label>
        <input type="range" id="cycle-speed-slider" min="0.1" max="10" step="0.1" onchange="setCycleSpeed(this.value)">
        <span id="cycle-speed-value"></span>
        <span id="cycle-time-display" style="min-width: 200px;"></span>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Host IP</th>
                <th>Status</th>
                <th>Temp (째C)</th>
                <th>AC Spannung (V)</th>
                <th>AC Strom (A)</th>
                <th>Wirkleistung (W)</th>
                <th>Leistungsfaktor</th>
                <th>Frequenz (Hz)</th>
                <th>Tagesertrag (kWh)</th>
                <th>DC Leistung (W)</th>
                <th>Fehlercode</th>
                <th>Aktion</th>
            </tr>
        </thead>
        <tbody id="server-status-body">
            <!-- Daten werden hier per JavaScript eingef체gt -->
        </tbody>
    </table>

    <h2 style="text-align: center; color: #2c3e50; margin-top: 40px;">Wallbox Simulatoren</h2>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Host IP</th>
                <th>Status</th>
                <th>Ladeleistung (W)</th>
                <th>Ladezustand (SoC)</th>
                <th>Geladene Energie (kWh)</th>
                <th>Fehlercode</th>
                <th>Aktion</th>
                <th>SoC setzen</th>
            </tr>
        </thead>
        <tbody id="wallbox-status-body">
            <!-- Daten werden hier per JavaScript eingef체gt -->
        </tbody>
    </table>

    <script>
        function updateStatus() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    // --- PV-Simulatoren aktualisieren ---
                    const pvBody = document.getElementById('server-status-body');
                    pvBody.innerHTML = '';
                    const currentSpeed = data.day_cycle_increment;
                    document.getElementById('cycle-speed-slider').value = currentSpeed;
                    updateCycleSpeedDisplay(currentSpeed);

                    data.servers.forEach(([instanceId, server]) => {
                        const row = document.createElement('tr');
                        const defaults = { status: "Initializing", temp: "N/A", ac_voltage: "N/A", ac_current: "N/A", active_power: "N/A", power_factor: "N/A", frequency: "N/A", daily_yield: "N/A", dc_power: "N/A", fault_code: "N/A", op_state: 0 };
                        const displayData = { ...defaults, ...server };

                        let statusText = displayData.status;
                        let statusClass = 'status-initializing';
                        if (displayData.status === 'Running') {
                            if (displayData.op_state === 2) { statusText = 'Einspeisung'; statusClass = 'status-running'; }
                            else if (displayData.op_state === 1) { statusText = 'Standby'; statusClass = 'status-standby'; }
                        } else if (displayData.status.startsWith('Fault')) { statusText = 'Fehler'; statusClass = 'status-fault';
                        } else if (displayData.status.startsWith('Error')) { statusText = 'Verbindungsfehler'; statusClass = 'status-error'; }

                        row.innerHTML = `<td>${instanceId}</td><td>${displayData.host_ip}</td><td class="${statusClass}">${statusText}</td><td>${displayData.temp}</td><td>${displayData.ac_voltage}</td><td>${displayData.ac_current}</td><td>${displayData.active_power}</td><td>${displayData.power_factor}</td><td>${displayData.frequency}</td><td>${displayData.daily_yield}</td><td>${displayData.dc_power}</td><td>${displayData.fault_code}</td><td><button onclick="injectFault(${instanceId})">Fehler erzeugen</button></td>`;
                        pvBody.appendChild(row);
                    });

                    // --- Wallbox-Simulatoren aktualisieren ---
                    const wallboxBody = document.getElementById('wallbox-status-body');
                    wallboxBody.innerHTML = '';
                    data.wallboxes.forEach(([instanceId, wallbox]) => {
                        const row = document.createElement('tr');
                        const defaults = { status: "Initializing", charging_power: "N/A", soc: "N/A", charged_energy: "N/A", fault_code: "N/A", state: 1 };
                        const displayData = { ...defaults, ...wallbox };

                        let statusClass = 'status-initializing';
                        if (displayData.state === 2) statusClass = 'status-running'; // Ladevorgang
                        else if (displayData.state === 1) statusClass = 'status-standby'; // Bereit
                        else if (displayData.state === 3) statusClass = 'status-fault'; // Fehler

                        const chargeButtonText = displayData.state === 2 ? 'Laden stoppen' : 'Laden starten';
                        const chargeButtonFunc = `toggleCharging(${instanceId}, ${displayData.state})`;
                        const chargeButtonDisabled = displayData.state === 3 ? 'disabled' : '';
                        const socInputDisabled = displayData.state !== 1 ? 'disabled' : '';

                        row.innerHTML = `
                            <td>${instanceId}</td>
                            <td>${displayData.host_ip}</td>
                            <td class="${statusClass}">${displayData.status}</td>
                            <td>${displayData.charging_power}</td>
                            <td>${displayData.soc}</td>
                            <td>${displayData.charged_energy}</td>
                            <td>${displayData.fault_code}</td>
                            <td>
                                <button onclick="${chargeButtonFunc}" ${chargeButtonDisabled}>${chargeButtonText}</button>
                                <button onclick="injectWallboxFault(${instanceId})">Fehler erzeugen</button>
                            </td>
                            <td>
                                <input type="number" id="soc-input-${instanceId}" min="0" max="100" style="width: 60px;" value="${Math.round(parseFloat(displayData.soc))}" ${socInputDisabled}>
                                <button onclick="setSoC(${instanceId})" ${socInputDisabled}>Setzen</button>
                            </td>
                        `;
                        wallboxBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Fehler beim Abrufen der Daten:', error);
                    const pvBody = document.getElementById('server-status-body');
                    pvBody.innerHTML = '<tr><td colspan="13" style="text-align:center; color: red;">Fehler beim Laden der Daten.</td></tr>';
                    const wallboxBody = document.getElementById('wallbox-status-body');
                    wallboxBody.innerHTML = '<tr><td colspan="9" style="text-align:center; color: red;">L채uft der Server?</td></tr>';
                });
        }

        function injectFault(instanceId) {
            fetch(`/inject_fault/${instanceId}`, { method: 'POST' }).then(res => res.json()).then(data => console.log(data.message));
        }

        function toggleCharging(instanceId, state) {
            const action = state === 2 ? 'stop_charging' : 'start_charging';
            fetch(`/${action}/${instanceId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => console.log(data.message));
        }

        function injectWallboxFault(instanceId) {
            fetch(`/inject_wallbox_fault/${instanceId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => console.log(data.message));
        }

        function setSoC(instanceId) {
            const input = document.getElementById(`soc-input-${instanceId}`);
            const socValue = input.value;
            if (socValue === "" || socValue < 0 || socValue > 100) {
                alert("Bitte geben Sie einen SoC-Wert zwischen 0 und 100 ein.");
                return;
            }
            fetch(`/set_soc/${instanceId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ soc: socValue })
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message)
                // Optional: force an immediate update to reflect the change visually
                // updateStatus();
            });
        }

        function updateCycleSpeedDisplay(speed) {
            const speedValue = parseFloat(speed);
            document.getElementById('cycle-speed-value').textContent = `Faktor: ${speedValue.toFixed(1)}`;
            const totalMinutes = (360 / speedValue) * 2 / 60;
            document.getElementById('cycle-time-display').textContent = `(ca. ${totalMinutes.toFixed(1)} Min./Zyklus)`;
        }

        function setCycleSpeed(speed) {
            updateCycleSpeedDisplay(speed);
            fetch('/set_cycle_speed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ speed: speed })
            })
            .then(response => response.json())
            .then(data => console.log(data.message))
            .catch(error => console.error('Fehler beim Setzen der Zyklusgeschwindigkeit:', error));
        }

        // Update alle 2 Sekunden
        setInterval(updateStatus, 2000);

        // Initialer Ladevorgang
        document.addEventListener('DOMContentLoaded', updateStatus);
    </script>

</body>
</html>
